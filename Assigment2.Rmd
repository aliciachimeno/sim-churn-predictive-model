---
title: "Assigment 2"
author: "Alícia Chimeno Sarabia and Bruna"
date: "2023-12-02"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

# Libraries
```{r}
library(skimr)
library(car)
```

# Load dataset
```{r}
#setwd("/Users/ali/Desktop/MASTER/SIM/proj2")
setwd("C:/Users/Brunil/Desktop/Bruna/Master/SIM/assignment_2")
df<-read.csv("customer.xls", sep=",")
```

# Data context
This dataset contains information about customers. Demographic data, 

# Data exploration

```{r}
dim(df)
names(df)
str(df)
#summary(df)
#skim(df)
summary(is.na(df)) #we only have NA values in TotalCharges
```

## Variables description
In total, we have 21 variables related to demographic, services, and accountant data. One is the ID, three are numerical variables, and 17 are categorical (? binary) variables. We will conduct a descriptive analysis and a data quality report for each variable, considering aspects such as the number of missing values, errors, and the distribution or balance of the variable...
#### 1. customerID 

### Demographic data
#### 2. gender
Is a binary variable (female/male). 
```{r}
sum(is.na(df$gender))
table(df$gender)
barplot(table(df$gender), main = "Distribution of gender",xlab = "Gender",col = "skyblue")
```

#### 3. SeniorCitizen
Is a binary variable, YES/NO. 
```{r}
sum(is.na(df$SeniorCitizen))
table(df$SeniorCitizen)
barplot(table(df$SeniorCitizen), main = "Distribution of SeniorCitizen",xlab = "SeniorCitizen",col = "skyblue")
```

#### 4. Partner
It is a binary variable. Levels: Yes/No. 
```{r}
sum(is.na(df$Partner))
table(df$Partner)
barplot(table(df$Partner), main = "Distribution of Partner",xlab = "Partner",col = "skyblue")
```


#### 5. Dependents
It is a binary variable. Levels: Yes/No. 
```{r}
sum(is.na(df$Dependents))
table(df$Dependents)
barplot(table(df$Dependents), main = "Distribution of Dependents",xlab = "Dependents",col = "skyblue")

```

### Services of the costumer data
Services that each customer has signed up for :
#### 6. tenure
It is a numerical variable that indicates the duration, in months, that the customer has stayed with the company. 
```{r}
summary(df$tenure)
hist(df$tenure,breaks=20, col="skyblue")
```

Outliers
```{r}
summary(is.na(df)) #no NA
boxplot(df$tenure, main="Outlier analysis for Tenure")

sm_t <- summary(df$tenure)
iqr_t <- sm_t["3rd Qu."] - sm_t["1st Qu."]
# Mild Outliers
mild_ub_t <- sm_t["3rd Qu."] + 1.5 * iqr_t
mild_lb_t <- sm_t["1st Qu."] - 1.5 * iqr_t
length(which(df$tenure > mild_ub_t | df$tenure < mild_lb_t)) # number of mild outliers

# Severe Outliers
severe_ub_t <- sm_t["3rd Qu."] + 3 * iqr_t
severe_lb_t <- sm_t["1st Qu."] - 3 * iqr_t
length(which(df$tenure > severe_ub_t | df$tenure < severe_lb_t)) # number of severe outliers

#no tenim outliers

```

#### 7. PhoneService 
It is a binary variable. Levels: Yes/No. 
```{r}
sum(is.na(df$PhoneService))
table(df$PhoneService)
barplot(table(df$PhoneService), main = "Distribution of PhoneService",xlab = "PhoneService",col = "skyblue")
```

#### 8. MultipleLines
It is a binary variable. Levels: Yes/No. 
```{r}
sum(is.na(df$MultipleLines))
table(df$MultipleLines)
```

```{r}
# check inconsistencies
subset(df, MultipleLines == "Yes" & PhoneService == "No") 
```


#### 9. InternetService
It is a binary variable. Levels: Yes/No. 

```{r}
table(df$InternetService)
```

#### 10. OnlineSecurity
It is a factor variable with 3 levels: 
```{r}
table(df$OnlineSecurity)
```

```{r}
# Check concistency
sum(df$InternetService == "No")
sum(df$OnlineSecurity == "No internet service")
```


#### 11. OnlineBackup

It is a factor variable with 3 levels:
```{r}
table(df$OnlineBackup)
```

```{r}
# Check concistency
sum(df$OnlineBackup == "No internet service") #1526
sum(df$OnlineSecurity == "No internet service") #1526
```

#### 12. DeviceProtection

It is a factor variable with 3 levels:

```{r}
table(df$DeviceProtection)
```


```{r}
# Check concistency
sum(df$OnlineSecurity == "No internet service") #1526
sum(df$DeviceProtection == "No internet service") #1526
```

#### 13. TechSupport

It is a factor variable with 3 levels:

```{r}
table(df$TechSupport)
```
```{r}
#Check consistency

sum(df$DeviceProtection == "No internet service") #1526
sum(df$TechSupport == "No internet service") #1526
```

#### 14. StreamingTV

It is a factor variable with 3 levels:

```{r}
table(df$StreamingTV)
```
```{r}
#Check consistency
sum(df$TechSupport == "No internet service") #1526
sum(df$StreamingTV == "No internet service") #1526
```
#### 15. StreamingMovies
```{r}
table(df$StreamingMovies)
```

```{r}
#Check consistency

sum(df$StreamingTV == "No internet service") #1526
sum(df$StreamingMovies == "No internet service") #1526

```


### Customer account data
#### 16. Contract

#### 17. PaperlessBilling
Is a binary variable. 

#### 18. PaymentMethod
Is a factor variable with 4 levels: 

#### 19. MonthlyCharges (numeric)

```{r}
summary(df$MonthlyCharges)
hist(df$MonthlyCharges,breaks=20)
```


```{r}
Boxplot(df$MonthlyCharges, main="Outlier analysis for MonthlyCharges")
sm <- summary(df$MonthlyCharges)
iqr <- sm["3rd Qu."] - sm["1st Qu."]
# Mild Outliers
mild_ub <- sm["3rd Qu."] + 1.5 * iqr
mild_lb <- sm["1st Qu."] - 1.5 * iqr
length(which(df$MonthlyCharges > mild_ub | df$MonthlyCharges < mild_lb)) # number of mild outliers

# Severe Outliers
severe_ub <- sm["3rd Qu."] + 3 * iqr
severe_lb <- sm["1st Qu."] - 3 * iqr
length(which(df$MonthlyCharges > severe_ub | df$MonthlyCharges < severe_lb)) # number of severe outliers

```


#### 20. TotalCharges (numeric)



```{r}
summary(df$TotalCharges)
hist(df$TotalCharges,breaks=20)
```


```{r}
Boxplot(df$TotalCharges, main="Outlier analysis for TotalCharges")
sm <- summary(df$TotalCharges)
iqr <- sm["3rd Qu."] - sm["1st Qu."]
# Mild Outliers
mild_ub <- sm["3rd Qu."] + 1.5 * iqr
mild_lb <- sm["1st Qu."] - 1.5 * iqr
length(which(df$TotalCharges > mild_ub | df$TotalCharges < mild_lb)) # number of mild outliers

# Severe Outliers
severe_ub <- sm["3rd Qu."] + 3 * iqr
severe_lb <- sm["1st Qu."] - 3 * iqr
length(which(df$TotalCharges > severe_ub | df$TotalCharges < severe_lb)) # number of severe outliers

```


Imputation for NA values (ho vols fer aquí o més endavant? com és l'única variable amb NA)
```{r}

```

### Target: 
#### 21. Churn
It is the target variable. It is binary, describes whether the customer churned or not (Yes or No). 


## Data preprocessing
### Recode variables into correct type
We shall reconvert the type of certain variables that are encoded with wrong type. First, we convert the character variables (except the ID) into factors.
```{r}
char_cols <- which(sapply(df, is.character))
df[, char_cols[-1]]<- lapply(df[, char_cols[-1]], as.factor) 
```

Also, we convert the numerical variable SeniorCitizen into a factor.  
```{r}
df$SeniorCitizen<- factor(df$SeniorCitizen)
```

```{r}
summary(df)
str(df)
```

### Data imputation
```{r}
summary(is.na(df))
```
Only the variable TotalCharges has NA's. 

```{r}
df[is.na(df$TotalCharges), ]
df[df$tenure==0,]
df[df$TotalCharges==0, ]
summary(df$TotalCharges)
```
The missing data corresponds to the individuals that have not payed yet the charges of the current month, we can guess that are new clients of the company.

Duplicate values: no
```{r}
dim(df)
length(unique(df$customerID))
```


El significat d'aquestos NA son que l'individuu encara no se li ha cobrat el charges ja que no ha arribat a final de més. Una possible solució seria que la variable totalcharges prengui el valor de monthlycharges. 

Suggerim quan tenure==0 eliminem les observacions enlloc d'imputar-les ja que representen un 0.1% de les dades.  NO ELIMINEM FIQUEM 0
```{r}
ll <- which(is.na(df$TotalCharges))
df[ll,"TotalCharges"] <- 0
summary(is.na(df$TotalCharges))
```

Això crec que és un pas que està descrit al pdf però no sé perquè s'ha de fer

Create variable adding the total number missing values, outliers and errors. Describe these variables, to which other variables exist higher associations.  Compute the correlation with all other variables. Rank these variables according the correlation  Compute for every group of individuals (group of age, size of town, singles, married, …) the mean of missing/outliers/errors values. Rank the groups according the computed mean. 


###Modelling

Modelling:
Train - test → dubte: abans o després de balancejar les dades?
The dataset is imbalanced.
Use only glm() modeling tools (parametric and traditional statistical models, baseline for comparison to ML approaches being developed in other subjects)
Assessment metric: area under the ROC curve score and confusion table prediction capability analysis (recall, F1-score, etc) for train sample and confusion table for test sample


```{r}
set.seed(1234)
m <- floor(0.7*nrow(df))
train_d <- sample(seq_len(nrow(df)),size = m)

train <- df[train_d,]
test <- df[-train_d,]

names(df)
```

Target variable is Churn

Això ho podem posar a l'annex i deixem els comentaris al report

Univariate

```{r}
attach(train)
names(train)

mod <- glm(Churn ~ gender, data=train, family=binomial)
summary(mod)

mod2 <- glm(Churn ~ SeniorCitizen, data=train, family=binomial)
summary(mod2)

mod3 <- glm(Churn ~ Partner, data=train, family=binomial)
summary(mod3)

mod4 <- glm(Churn ~ Dependents, data=train, family=binomial)
summary(mod4)

mod5 <- glm(Churn ~ tenure, data=train, family=binomial)
summary(mod5)

mod6 <- glm(Churn ~ PhoneService, data=train, family=binomial)
summary(mod6)

mod7 <- glm(Churn ~ MultipleLines, data=train, family=binomial)
summary(mod7)

mod8 <- glm(Churn ~ InternetService, data=train, family=binomial)
summary(mod8)

mod9 <- glm(Churn ~ OnlineSecurity, data=train, family=binomial)
summary(mod9)

mod10 <- glm(Churn ~ OnlineBackup, data=train, family=binomial)
summary(mod10)

mod11 <- glm(Churn ~ DeviceProtection, data=train, family=binomial)
summary(mod11)

mod12 <- glm(Churn ~ TechSupport, data=train, family=binomial)
summary(mod12)

mod13 <- glm(Churn ~ StreamingTV, data=train, family=binomial)
summary(mod13)

mod14 <- glm(Churn ~ StreamingMovies, data=train, family=binomial)
summary(mod14)

mod15 <- glm(Churn ~ Contract, data=train, family=binomial)
summary(mod15)

mod16 <- glm(Churn ~ PaperlessBilling, data=train, family=binomial)
summary(mod16)

mod17 <- glm(Churn ~ PaymentMethod, data=train, family=binomial)
summary(mod17)

mod18 <- glm(Churn ~ MonthlyCharges, data=train, family=binomial)
summary(mod18)

mod19 <- glm(Churn ~ TotalCharges, data=train, family=binomial)
summary(mod19)
```


```{r}

md <- glm(Churn ~ gender+SeniorCitizen+Partner+Dependents+tenure+PhoneService+MultipleLines+InternetService+OnlineSecurity+OnlineBackup+DeviceProtection+TechSupport+StreamingTV+StreamingMovies+Contract+PaperlessBilling+PaymentMethod+MonthlyCharges+TotalCharges, data=train, family=binomial)
summary(md)
```



```{r}
#md <- glm(Churn ~ ., data = df, family = binomial)
#summary(md)
```




















