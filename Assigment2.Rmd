---
title: "Assignment 2"
author: "Al√≠cia Chimeno Sarabia and Bruna Barraquer Torres"
date: "2023-12-02"
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
    number_sections: true
    toc: true
  html_document: default
  word_document: default
classoption: twoside
geometry: margin=1in
editor_options:
  chunk_output_type: console
---

```{r, include=FALSE}
library(skimr)
library(car)
library(FactoMineR)
library(dplyr)
library(caret)
library(gridExtra)
library(pROC)
```


```{r, include=FALSE}
#setwd("/Users/ali/Documents/GitHub/projSIM")
setwd("C:/Users/Brunil/Desktop/Bruna/Master/SIM/assignment_2")
df<-read.csv("customer.xls", sep=",")
```

\newpage

# Data context

This dataset contains information about customers. Demographic data, 

# Data exploration

```{r, echo=FALSE }
dim(df)
names(df)
```

## Variable Description
In total, we have 21 variables related to demographic, services, and accountant data. One is the ID, three are numerical variables, and 17 are categorical variables. We will conduct a descriptive analysis and a data quality report for each variable, considering aspects such as the number of missing values, errors, and the distribution or balance of the variable...

**customerID**

We won't need this variable for the analysis nor the modelling.

### **Demographic data**

**gender**

Is a binary variable (female/male). It doesn't contain NA values.
```{r,echo=FALSE}
sum(is.na(df$gender))
table(df$gender)
```

**SeniorCitizen**

It is a binary variable. Levels: 1(=yes)/0(=no).  It doesn't contain NA values.
```{r, echo=FALSE}
sum(is.na(df$SeniorCitizen))
table(df$SeniorCitizen)
```

**Partner**

It is a binary variable. Levels: Yes/No. It doesn't contain NA values.

```{r, echo=FALSE}
sum(is.na(df$Partner))
table(df$Partner)
```

**Dependents**

It is a binary variable. Levels: Yes/No. It doesn't contain NA values.

```{r, echo = FALSE}
sum(is.na(df$Dependents))
table(df$Dependents)
```

```{r, echo=FALSE}
#plots
par(mfrow = c(2, 2))
barplot(table(df$gender), main = "Distribution of gender",xlab = "Gender",col = "skyblue") 
barplot(table(df$SeniorCitizen), main = "Distribution of SeniorCitizen",xlab = "SeniorCitizen",col = "skyblue")
barplot(table(df$Partner), main = "Distribution of Partner",xlab = "Partner",col = "skyblue")
barplot(table(df$Dependents), main = "Distribution of Dependents",xlab = "Dependents",col = "skyblue")
```


### **Services of the costumer data** 
Services that each customer has signed up for:


**tenure**

It is a numerical variable that indicates the duration, in months, that the customer has stayed with the company. We shall explore the statistics of the variable and look for the *outliers*
```{r, echo=FALSE, fig.width=6, fig.height=3}
summary(df$tenure)
par(mfrow = c(1, 2))
hist(df$tenure,breaks=20, col="skyblue", main="Histogram")
Boxplot(df$tenure, main="Outlier analysis")
```

```{r}
par(mfrow = c(1, 1))
sm_t <- summary(df$tenure)
iqr_t <- sm_t["3rd Qu."] - sm_t["1st Qu."]
# Mild Outliers
mild_ub_t <- sm_t["3rd Qu."] + 1.5 * iqr_t
mild_lb_t <- sm_t["1st Qu."] - 1.5 * iqr_t
length(which(df$tenure > mild_ub_t | df$tenure < mild_lb_t))
# number of mild outliers

# Severe Outliers
severe_ub_t <- sm_t["3rd Qu."] + 3 * iqr_t
severe_lb_t <- sm_t["1st Qu."] - 3 * iqr_t
length(which(df$tenure > severe_ub_t | df$tenure < severe_lb_t))
# number of severe outliers
```

There are **no mild nor severe outliers** in Tenure. 

**PhoneService**

It is a binary variable. Levels: Yes/No.  It doesn't contain NA values.
```{r, echo=FALSE}
sum(is.na(df$PhoneService))
table(df$PhoneService)
```

**MultipleLines**

Categorical variable with 3 levels, No/No phone service/Yes.  It doesn't contain NA values.
```{r, echo=FALSE}
sum(is.na(df$MultipleLines))
table(df$MultipleLines)
```

Check for inconsistencies:

- It cannot happen that a costumer has not Phoneservice and Multiplelines.

```{r, echo=FALSE}
subset(df, MultipleLines == "Yes" & PhoneService == "No") 
```


**InternetService**

Categorical variable with 3 levels: DSL/Fiber optic/No.  It doesn't contain NA values.
```{r,  echo=FALSE}
table(df$InternetService)
sum(is.na(df$InternetService))
```

**OnlineSecurity**

Categorical variable with 3 levels: No/No internet service/Yes.  It doesn't contain NA values.
```{r,  echo=FALSE}
table(df$OnlineSecurity)
sum(is.na(df$OnlineSecurity))
```

```{r,  echo=FALSE}
#plots: 
par(mfrow = c(2, 2))
barplot(table(df$PhoneService), main = "Distribution of PhoneService",xlab = "PhoneService",col = "skyblue") #unbalanced
barplot(table(df$MultipleLines), main = "Distribution of MultipleLines",xlab = "MultipleLines",col = "skyblue") #unbalanced
barplot(table(df$InternetService), main = "Distribution of InternetService",xlab = "InternetService",col = "skyblue") 
barplot(table(df$OnlineSecurity), main = "Distribution of OnlineSecurity",xlab = "OnlineSecurity",col = "skyblue") 
```

###### Check consistency
```{r}
sum(df$InternetService == "No")
sum(df$OnlineSecurity == "No internet service")
nrow(subset(df, InternetService == "No" & OnlineSecurity == "No internet service"))
```


**OnlineBackup**

Categorical variable with 3 levels: No/No internet service/Yes. It doesn't contain NA values.
```{r, echo=FALSE}
table(df$OnlineBackup)
sum(is.na(df$OnlineBackup))
```

```{r}
# Check concistency
sum(df$OnlineBackup == "No internet service") #1526
sum(df$OnlineSecurity == "No internet service") #1526
```

**DeviceProtection**
Categorical variable with 3 levels: No/No internet service/Yes. It doesn't contain NA values.
```{r, echo=FALSE}
table(df$DeviceProtection)
sum(is.na(df$DeviceProtection))
```

```{r}
# Check consistency
sum(df$OnlineSecurity == "No internet service") #1526
sum(df$DeviceProtection == "No internet service") #1526
```

**TechSupport**

Categorical variable with 3 levels: No/No internet service/Yes. It doesn't contain NA values.
```{r, echo=FALSE}
table(df$TechSupport)
sum(is.na(df$TechSupport))
```

```{r}
#Check consistency
sum(df$DeviceProtection == "No internet service") #1526
sum(df$TechSupport == "No internet service") #1526
```

**StreamingTV**
Categorical variable with 3 levels: No/No internet service/Yes. It doesn't contain NA values.
```{r, echo=FALSE}
table(df$StreamingTV)
sum(is.na(df$StreamingTV))
```

```{r}
#Check consistency
sum(df$TechSupport == "No internet service") #1526
sum(df$StreamingTV == "No internet service") #1526
```

**StreamingMovies**

Categorical variable with 3 levels: No/No internet service/Yes. It doesn't contain NA values.
```{r, echo=FALSE}
table(df$StreamingMovies)
sum(is.na(df$StreamingTV))
```

```{r}
#Check consistency
sum(df$StreamingTV == "No internet service") #1526
sum(df$StreamingMovies == "No internet service") #1526
```

```{r, echo=FALSE}
#plots: 
par(mfrow = c(2, 2))
barplot(table(df$OnlineBackup), main = "Distribution of OnlineBackup",xlab = "OnlineBackup",col = "skyblue") 
barplot(table(df$DeviceProtection), main = "Distribution of DeviceProtection",xlab = "DeviceProtection",col = "skyblue") 
barplot(table(df$TechSupport), main = "Distribution of TechSupport",xlab = "TechSupport",col = "skyblue")
barplot(table(df$StreamingTV), main = "Distribution of StreamingTV",xlab = "StreamingTV",col = "skyblue") 
barplot(table(df$StreamingMovies), main = "Distribution of StreamingMovies",xlab = "StreamingMovies",col = "skyblue")
```

### Customer account data

**Contract**
Categorical variable with 3 levels: Month-to-month/One year/Two year. It doesn't contain NA values.
```{r, echo=FALSE}
table(df$Contract)
sum(is.na(df$Contract))
```

**PaperlessBilling**
It is a binary variable. Levels: No/Yes. It doesn't contain NA values.
```{r}
table(df$PaperlessBilling)
sum(is.na(df$PaperlessBilling))
```

**PaymentMethod**
Categorical variable with 4 levels: Bank transfer (automatic)/Credit card (automatic)/Electronic check/Mailed check. It doesn't contain NA values.
```{r}
table(df$PaymentMethod)
sum(is.na(df$PaymentMethod))
```

```{r, echo=FALSE}
#plots
par(mfrow = c(2, 2))
barplot(table(df$Contract), main = "Distribution of Contract",xlab = "Contract",col = "skyblue")
barplot(table(df$PaperlessBilling), main = "Distribution of PaperlessBilling",xlab = "PaperlessBilling",col = "skyblue")
barplot(table(df$PaymentMethod), main = "Distribution of PaymentMethod",xlab = "PaymentMethod",col = "skyblue")
```


**MonthlyCharges**

It is a numerical variable. It doesn't contain NA values.
```{r, echo=FALSE, fig.width=6, fig.height=3}
summary(df$MonthlyCharges)
par(mfrow = c(1,2 ))
hist(df$MonthlyCharges,breaks=20,col="skyblue", main="Histogram")
Boxplot(df$MonthlyCharges, main="Outlier analysis")
sum(is.na(df$MonthlyCharges))
```

Let's look for *outliers*. 
```{r}
sm <- summary(df$MonthlyCharges)
iqr <- sm["3rd Qu."] - sm["1st Qu."]
# Mild Outliers
mild_ub <- sm["3rd Qu."] + 1.5 * iqr
mild_lb <- sm["1st Qu."] - 1.5 * iqr
length(which(df$MonthlyCharges > mild_ub | df$MonthlyCharges < mild_lb)) 

# Severe Outliers
severe_ub <- sm["3rd Qu."] + 3 * iqr
severe_lb <- sm["1st Qu."] - 3 * iqr
length(which(df$MonthlyCharges > severe_ub | df$MonthlyCharges < severe_lb)) 
```
There are no mild nor severe outliers in MonthlyCharges.

**TotalCharges**

It is a numerical variable. It does contain 11 NA values.
```{r, echo=FALSE, fig.width=6, fig.height=3}
summary(df$TotalCharges)
sum(is.na(df$TotalCharges))
par(mfrow = c(1, 2))
hist(df$TotalCharges,breaks=20,col="skyblue", main="Histogram")
Boxplot(df$TotalCharges, main="Outlier analysis")
sum(is.na(df$TotalCharges)) #NA values
```

Let's look for *outliers*.
```{r}
sm <- summary(df$TotalCharges)
iqr <- sm["3rd Qu."] - sm["1st Qu."]
# Mild Outliers
mild_ub <- sm["3rd Qu."] + 1.5 * iqr
mild_lb <- sm["1st Qu."] - 1.5 * iqr
length(which(df$TotalCharges > mild_ub | df$TotalCharges < mild_lb))

# Severe Outliers
severe_ub <- sm["3rd Qu."] + 3 * iqr
severe_lb <- sm["1st Qu."] - 3 * iqr
length(which(df$TotalCharges > severe_ub | df$TotalCharges < severe_lb))
```
There are no mild nor severe outliers.

### Target variable: 
**Churn**
It is the target variable. It is binary, describes whether the customer churned or not (Yes or No). 

```{r,fig.width=3, fig.height=3}
table(df$Churn)
prop.table(table(df$Churn))
barplot(table(df$Churn), col="skyblue")
sum(is.na(df$Churn))
```


# Data preprocessing
### Recode variables into correct type
We shall reconvert the type of certain variables that are encoded with wrong type. First, we convert the character variables (except the ID) into factors.
```{r}
char_cols <- which(sapply(df, is.character))
df[, char_cols[-1]]<- lapply(df[, char_cols[-1]], as.factor) 
```

Also, we convert the numerical variable SeniorCitizen into a factor.  
```{r}
df$SeniorCitizen<- factor(df$SeniorCitizen)
```

### Data imputation
```{r, echo=FALSE}
summary(is.na(df))
```
Only the variable TotalCharges has NA's. 

The missing data corresponds to the individuals that have not payed yet the charges of the current month, we can guess that are new clients of the company.

Duplicate values: no
```{r}
length(unique(df$customerID))
```

These NA exist because the costumer hasn't payed yet that month (tenure is 0). We convert these NA to 0.

```{r}
ll <- which(is.na(df$TotalCharges))
df[ll,"TotalCharges"] <- 0
```


### Correlation between categorical

The categorical variables MultipleLines and PhoneService are 100% correlated. We might have multicollinearity between these two variables.
```{r}
contingency_table<-table(df$MultipleLines,df$PhoneService)
sqrt(chisq.test(contingency_table)$statistic / (sum(contingency_table) * (min(dim(contingency_table)) - 1)))
```


### Profiling 

```{r}
res.cat=catdes(df, 21)
res.cat$test.chi2
lapply(res.cat$category, head, n = 5)
lapply(res.cat$category, tail, n = 5)
res.cat$quanti.var
```

Regarding to the results of the test $Chi^2$ all correlations with the variables
are significant since the $p-value$ is less than 0,05.
Since the response variable is binary, we have different results for each answer and also for all outcomes of the categorical parameters.

The parameters that have a higher positive relation with the costumers that don't churn are the ones that have a negative relation when the response variable is "Yes". In the same vein, we can observe that the parameters that have a negative relation with the costumers that churn are "OnlineSecurity" and "TechSupport" when the answer is "No", the same parameters that have a positive relation when the costumers churn. We can see that the target answer "Yes" and "No" have an approximate opposite correlations with the explanatory variables.

## Modelling

### Data transformations: 

Recall that the following variables:
\begin{itemize}
\item OnlineSecurity
\item OnlineBackup
\item DeviceProtection
\item TechSupport
\item StreamingTV
\item StreamingMovies
\end{itemize}
are categorical variables with 3 levels: No/No internet service/Yes. 

We observe that they contain "No internet service" as a response. We have a variable called *InternetService* that is a categorical variable with 3 levels: DSL/Fiber optic/No. Whenever *InternetService*="No" implies -> var="No internet service". Therefore we decided to transform the level "No internet service" into "No" in the 6 variables above since this variable will specify. 



```{r}
df$OnlineSecurity[df$OnlineSecurity=="No internet service"] <- "No"
df$OnlineBackup[df$OnlineBackup=="No internet service"] <- "No"
df$DeviceProtection[df$DeviceProtection=="No internet service"] <- "No"
df$TechSupport[df$TechSupport=="No internet service"] <- "No"
df$StreamingTV[df$StreamingTV=="No internet service"] <- "No"
df$StreamingMovies[df$StreamingMovies=="No internet service"] <- "No"
```

We saw that *MultipleLines* is 100% related with *PhoneService*. The reason is similar as the previous parameters: one answer of *MultipleLines* is "No phone service". We set this answer to "No" since we don't lose the information because it is contained inside the parameter *PhoneService*.

```{r}
df$MultipleLines[df$MultipleLines=="No phone service"] <- "No"
```

### Modelling:

```{r}
set.seed(1234)
m <- floor(0.7*nrow(df))
train_d <- sample(seq_len(nrow(df)),size = m)

train <- df[train_d,]
test <- df[-train_d,]
```

Recall that the target variable is *Churn*. 

### Numerical Variables

**Null Model**

We start the modelling by the null model.
```{r}
mod0 <- glm(Churn ~ 1, data=train, family=binomial)
mod0$deviance
```

We continue by adding the numerical variables and assessing the model.
```{r}
which(sapply(df, is.numeric))
```

**Tenure**

```{r}
mod1 <- glm(Churn ~ tenure, data=train, family=binomial)
mod1$deviance;AIC(mod0,mod1) #summary(mod1)
anova( mod0, mod1,  test="Chisq")

```

**MonthlyCharges**

```{r}
mod2 <- glm(Churn ~ tenure + MonthlyCharges, data=train, family=binomial)
mod2$deviance
AIC(mod2) #4473.45
anova( mod1, mod2,  test="Chisq")
```

**TotalCharges**

```{r}
mod3 <- glm(Churn ~ tenure + MonthlyCharges + TotalCharges, data=train, family=binomial)
mod3$deviance  
anova( mod2, mod3,  test="Chisq") #significant
AIC(mod3) #4468.55
vif(mod3)
```
It is significant enough but we can also see that *TotalCharges* has a high VIF, so it has high multicollinearity. We decide to not include it in the model.


### Inlfuential data
```{r}
infl <- influence.measures(mod3)

sum(residuals(mod3,'deviance')^2)
sum(residuals(mod3,'pearson')^2)

influential_indices <- which(infl$is.inf == TRUE)
length(influential_indices)
length(train$customerID)
```
We have 209 influential points out of 4930.


### Residuals
```{r, fig.width=4, fig.height=4}
par(mfrow = c(2, 2))
residualPlots(mod3)
```

The residuals need to be nearer to the 0 and they have homocedasticity.

### Categorical Variables

Now, we shall add the categorical variables. The order of addition is significant, therefore we start by adding the most correlated variables with the target. 

**Contract*

```{r}
mod4 <- glm(Churn ~ tenure + MonthlyCharges + Contract, data=train, family=binomial)
AIC(mod4) #4302.2 better
anova( mod3, mod4,  test="Chisq") #significant
vif(mod4)
```
We add the parameter because it improves the model.

**InternetService**

```{r}
mod5 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService, data=train, family=binomial)
AIC(mod5) #4254.1 better
anova( mod4, mod5,  test="Chisq") #significant
vif(mod5)
```

**StreamingMovies**


```{r, fig.align='center'}
mod6 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
              StreamingMovies, data=train, family=binomial)
AIC(mod6) #4238.6 better
anova( mod5, mod6,  test="Chisq") #significant
vif(mod6)
```
The model has improved but the VIF is becoming higher.


**StreamingTV**

```{r}
mod7 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
              StreamingMovies + StreamingTV, data=train, family=binomial)
AIC(mod7) #4213.5 better
anova( mod6, mod7,  test="Chisq") #significant
vif(mod7)
```

*MonthlyCharges* has a high VIF. We'll may need to add transformations or maybe discard this variable. For now, we will keep the parameters that we have been adding.

**TechSupport**

```{r}
mod8 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
      StreamingMovies + StreamingTV + TechSupport, data=train, family=binomial)
#summary(mod8) #4208.3 better
AIC(mod8)
anova( mod7, mod8,  test="Chisq") #significant
vif(mod8)
```

Including *TechSupport* improves the model.

**DeviceProtection**

```{r}
mod9 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
            StreamingMovies + StreamingTV + TechSupport + DeviceProtection, 
            data=train, family=binomial)
summary(mod9) #4209.3 worse
AIC(mod9)
anova( mod8, mod9,  test="Chisq") #not significant

```

We don't add the variable to the model. It does not improve it.

**OnlineBackup**

```{r}
mod10 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineBackup, 
             data=train, family=binomial)
AIC(mod10) #4209.6 worse
anova( mod8, mod10,  test="Chisq") #not significant
```
We don't add the variable to the model. It does not improve it.

**OnlineSecurity**

```{r}
mod11 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity, 
             data=train, family=binomial)
AIC(mod11) #4199 better
anova( mod8, mod11,  test="Chisq") #significant
vif(mod11)
```

We keep the variable. We still have multicollinearity, but we'll deal with it later.

**PaperlessBilling**

```{r}
mod12 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity +
               PaperlessBilling, data=train, family=binomial)
summary(mod12) #4184.5 better
AIC(mod12)
anova( mod11, mod12,  test="Chisq") #significant
vif(mod12)
```

We keep the variable because it improves the model.

**Dependents**

```{r}
mod13 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + 
               PaperlessBilling + Dependents, data=train, family=binomial)
summary(mod13) #4177.2 better
AIC(mod13)
anova( mod12, mod13,  test="Chisq") #significant
vif(mod13)
```

We keep the variable because it improves the model.

**MultipleLines**

```{r}
mod14 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + 
               PaperlessBilling + Dependents + MultipleLines,
             data=train, family=binomial)
AIC(mod14) #4162.2 better
anova( mod13, mod14,  test="Chisq") #significant
vif(mod14)
```

We keep the variable because it improves the model.

**SeniorCitizen**

```{r}
mod15 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService +
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity +
               PaperlessBilling + Dependents + MultipleLines + SeniorCitizen,
             data=train, family=binomial)
AIC(mod15) #4155.7 better
anova( mod14, mod15,  test="Chisq") #significant
vif(mod15)
```

We keep the variable because it improves the model.

**Partner**

```{r}
mod16 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + 
               PaperlessBilling + Dependents + MultipleLines + SeniorCitizen + 
               Partner, data=train, family=binomial)
AIC(mod16) #4157.7 worse
anova( mod15, mod16,  test="Chisq") #not significant
```

We don't keep the variable because it does not improve the model.

**PaymentMethod**

```{r}
mod17 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + 
               PaperlessBilling + Dependents + MultipleLines + SeniorCitizen + 
               PaymentMethod, data=train, family=binomial) 
AIC(mod17) #4139.4 better
anova( mod15, mod17,  test="Chisq") #significant
vif(mod17)
```

We keep the variable because it improves the model.

**PhoneService**

```{r}
mod18 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + 
               PaperlessBilling + Dependents + MultipleLines + SeniorCitizen + 
               PaymentMethod + PhoneService, data=train, family=binomial)
AIC(mod18)#4139.4 it does not change anything
anova( mod17, mod18,  test="Chisq") #not significant
```

We don't include the parameter because it does not improve the model.

### Inlfuential data

We check the influential data after including all categorical variables .

```{r}
infl_2 <- influence.measures(mod17)

sum(residuals(mod17,'deviance')^2)
sum(residuals(mod17,'pearson')^2)

influential_indices_2 <- which(infl_2$is.inf == TRUE)
length(influential_indices_2)
length(train$customerID)
```

The influential data has reduced until 98 tuples.


### Interactions

We need to search for interactions. Possible interactions:

#### Dependents and Multiple Lines

```{r}
mod19 <- glm(Churn ~ tenure + MonthlyCharges + Contract + InternetService + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity +
               PaperlessBilling + Dependents * MultipleLines + SeniorCitizen + 
               PaymentMethod, data=train, family=binomial)
 #4140.4 worse
AIC(mod19)
anova( mod17, mod19,  test="Chisq") #not significant
```
We don't include the interaction since it is not significative


**MonthlyCharges and InternetService**

```{r}
mod20 <- glm(Churn ~ tenure + InternetService * MonthlyCharges + Contract + 
               StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + 
               PaperlessBilling + Dependents + MultipleLines + SeniorCitizen + 
               PaymentMethod, data=train, family=binomial)
AIC(mod20) #4133.7 better
anova( mod17, mod20,  test="Chisq") #significant
vif(mod20)
```

This interaction is significative

**SeniorCitizen and PaymentMethod**

```{r}
mod21 <- glm(Churn ~ tenure + InternetService + MonthlyCharges + Contract + StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + PaperlessBilling + Dependents + MultipleLines + SeniorCitizen * PaymentMethod, data=train, family=binomial)
AIC(mod21) #4133 better and also better than mod20
anova( mod17, mod21,  test="Chisq") #significant
anova( mod20, mod21,  test="Chisq") #not significant
vif(mod21) #better multicollinearity

mod22 <- glm(Churn ~ tenure + InternetService * MonthlyCharges + Contract + StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + PaperlessBilling + Dependents + MultipleLines + SeniorCitizen * PaymentMethod, data=train, family=binomial)
AIC(mod22) #4126.8 better

anova( mod21, mod22,  test="Chisq") #significant
anova( mod20, mod22,  test="Chisq") #significant

vif(mod22)
```
Having both interactions improves the model but VIF gets worse. The best model is with SeniorCitizen and PaymentMethod interaction (mod21)

**Second Order variable**

```{r}
mod23 <- glm(Churn ~ tenure + I(tenure^2) + InternetService + MonthlyCharges + 
               Contract + StreamingMovies + StreamingTV + TechSupport + 
               OnlineSecurity + PaperlessBilling + Dependents + MultipleLines + 
               SeniorCitizen * PaymentMethod, data=train, family=binomial)
AIC(mod23) #4088.4 better
anova( mod21, mod23,  test="Chisq") #significant
vif(mod23)
```

```{r}
mod23.1 <- glm(Churn ~ tenure + I(tenure^2) + InternetService + Contract + 
                 StreamingMovies + StreamingTV + TechSupport + OnlineSecurity + 
                 PaperlessBilling + Dependents + MultipleLines + 
                 SeniorCitizen * PaymentMethod, data=train, family=binomial)
AIC(mod23.1) #4093.9 worse
anova( mod23, mod23.1,  test="Chisq") #significant
vif(mod23.1) #better vif
```

Removing *MonthlyCharges* from the model is getting a bit worse the AIC but the change is significant and it improves the VIF.

For improving the multicollinearity we add log in *tenure*

```{r}
mod23.4 <- glm(Churn ~ log(tenure + 0.01) + I(tenure^2) + InternetService + 
                 Contract + StreamingMovies + StreamingTV + TechSupport + 
                 OnlineSecurity + PaperlessBilling + Dependents + MultipleLines
               + SeniorCitizen * PaymentMethod, data=train, family=binomial)
AIC(mod23.4) #4059.53
vif(mod23.4)
```

We keep this last model because we have the best AIC with the best VIF. 


### Inlfuential data

We check the influential data after including the interactions and the second order variable. 
```{r}
infl_3 <- influence.measures(mod23.4)
sum(residuals(mod23.4,'deviance')^2)
sum(residuals(mod23.4,'pearson')^2)
influential_indices_3 <- which(infl_3$is.inf == TRUE)
length(influential_indices_3)
length(train$customerID)
#Leverage values
plot(hatvalues(mod23.1), pch = 19, main = "Leverage Plot")
abline(h = 2 * ncol(model.matrix(mod23.1))/length(df$customerID), 
       col = "red", lty = 2)
```

We have more influential data than before, 399 tuples. We see that they are distributed randomly. We consider to not delete this data because it gives us important information for the model.

### Residuals

```{r, echo=FALSE}
residualPlots(mod23.4)
```

We see that we have improved the residuals of the model. We can observe that we have homoscedasticity because they are randomly distributed considering that the model is binary.

### Predictions


```{r}
#selecting the parameters that we have in the model
test_data <- test[c(3,5,6,8,9,10,13,14,15,16,17,18)]
pred_prob <- predict(mod23.4, newdata = test_data, type="response")
churn_pred<- ifelse(pred_prob>0.5,"Yes","No")
table(churn_pred)
table(test$Churn)
#Confusion table
tt <- table(churn_pred, test$Churn);tt
100*sum(diag(tt))/sum(tt) #80.79
```

The accuracy of our model is good, it is $80.79%$.

```{r}
roc_curve <- roc(test$Churn, pred_prob)
# Plot the ROC curve
plot(roc_curve, main = "ROC Curve", col = "blue", lwd = 2)
# Add diagonal reference line for comparison
abline(a = 0, b = 1, lty = 2, col = "red")
# Add AUC (Area Under the Curve) value to the plot
text(0.8, 0.2, paste("AUC =", round(auc(roc_curve), 2)), col = "blue", cex = 1.2)
```

Our Area Under the Curve for ROC curve is 0.85 so it is high.


#Interpretation

## Final Model

Our **final model** is:

```{r, include=FALSE}
coef(mod23.4)
```

\[
\begin{aligned}
Y &= -0.58 - 0.5 \cdot log(\text{tenure}+0.01) + 0.00005 \cdot \text{tenure}^2 \\
&\quad + 0.54 \cdot \text{InternetServiceFiber optic} - 0.97 \cdot \text{InternetServiceNo} \\
&\quad - 0.75 \cdot \text{ContractOne year} - 1.90 \cdot \text{ContractTwo year} \\
&\quad + 0.26 \cdot \text{StreamingMoviesYes} + 0.33 \cdot \text{StreamingTVYes} \\
&\quad - 0.22 \cdot \text{TechSupportYes} - 0.28 \cdot \text{Online SecurityYes} \\
&\quad + 0.33 \cdot \text{PaperlessBillingYes} - 0.23 \cdot \text{DependentsYes} \\
&\quad + 0.32 \cdot \text{MultipleLinesYes} - 0.15 \cdot \text{SeniorCitizen1} \\
&\quad - 0.25 \cdot \text{PaymentMethodCredit card} + 0.27 \cdot \text{PaymentMethodElectronic check} \\
&\quad - 0.25 \cdot \text{PaymentMethodMailed check} \\
&\quad + 0.87 \cdot \text{SeniorCitizen1:PaymentMethodCredit card} \\
&\quad + 0.28 \cdot \text{SeniorCitizen1: PaymentMethodElectronic check} \\
&\quad + 1.10 \cdot \text{SeniorCitizen1:PaymentMethodMailed check}
\end{aligned}
\]


\newpage

# Annex

## Univariate

```{r}
names(train)

mod <- glm(Churn ~ gender, data=train, family=binomial)
summary(mod)

mod2 <- glm(Churn ~ SeniorCitizen, data=train, family=binomial)
summary(mod2)

mod3 <- glm(Churn ~ Partner, data=train, family=binomial)
summary(mod3)

mod4 <- glm(Churn ~ Dependents, data=train, family=binomial)
summary(mod4)

mod5 <- glm(Churn ~ tenure, data=train, family=binomial)
summary(mod5)

mod6 <- glm(Churn ~ PhoneService, data=train, family=binomial)
summary(mod6)

mod7 <- glm(Churn ~ MultipleLines, data=train, family=binomial)
summary(mod7)

mod8 <- glm(Churn ~ InternetService, data=train, family=binomial)
summary(mod8)

mod9 <- glm(Churn ~ OnlineSecurity, data=train, family=binomial)
summary(mod9)

mod10 <- glm(Churn ~ OnlineBackup, data=train, family=binomial)
summary(mod10)

mod11 <- glm(Churn ~ DeviceProtection, data=train, family=binomial)
summary(mod11)

mod12 <- glm(Churn ~ TechSupport, data=train, family=binomial)
summary(mod12)

mod13 <- glm(Churn ~ StreamingTV, data=train, family=binomial)
summary(mod13)

mod14 <- glm(Churn ~ StreamingMovies, data=train, family=binomial)
summary(mod14)

mod15 <- glm(Churn ~ Contract, data=train, family=binomial)
summary(mod15)

mod16 <- glm(Churn ~ PaperlessBilling, data=train, family=binomial)
summary(mod16)

mod17 <- glm(Churn ~ PaymentMethod, data=train, family=binomial)
summary(mod17)

mod18 <- glm(Churn ~ MonthlyCharges, data=train, family=binomial)
summary(mod18)

mod19 <- glm(Churn ~ TotalCharges, data=train, family=binomial)
summary(mod19)

AIC(mod, mod1,mod2,mod3,mod4,mod5,mod6,mod7,mod8,mod9,mod10,mod11,mod12, mod13,mod14)
```

